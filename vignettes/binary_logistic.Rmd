---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(tibble)
library(dplyr)
library(tidyr)
library(cmdstanr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
```


```{r}
states <- data.frame(id = factor(c("Low", "High"), levels = c("Low", "High")))
trans_data <- tribble(~.from, ~.to, ~.reference,
                      "Low", "Low", TRUE,
                      "Low", "High", FALSE,
                      "High", "High", TRUE,
                      "High", "Low", FALSE
                      )
trans_model <- categorical_transitions(trans_data, states)

series_data <- tidyr::crossing(.serie = 1:3, .time = 1:10) |>
  mutate(observed = as.logical(rbinom(n(), size = 1, prob = if_else(.time < 5, 0.7, 0.3))))

obs_model <- ordered_binary_observations("observed")
init_model <- known_initial_states(rep("Low", 3))        

hmm <- brmshmmdata(~ 0 + .transition_id, series_data,
                   states_data = states,
                   init_model = init_model,
                   trans_model = trans_model,
                   obs_model = obs_model)

```


```{r}
#file.remove(list.files(here::here("temp_data"), pattern = ".stan", full.names = TRUE))
scode <- make_stancode_hmm(hmm)                   
file <- cmdstanr::write_stan_file(scode, dir = here::here("temp_data"))
m <- cmdstan_model(file)
d <- make_standata_hmm(hmm)
res <- m$sample(d, refresh = 500)
```

```{r}
res$cmdstan_summary()
```
```{r}
shinystan::launch_shinystan(rstan::read_stan_csv(res$output_files()))
```


```{r}
#### Setup ####
library(ggplot2)

P = 80 # persons
J = 60 # trials

#### Monotonic decreasing sim ####
intercept = runif(P, 0.7, 0.95)
slope = runif(P, -0.0075, -0.0025)

prob_true = matrix(NA, nrow=J, ncol=P)
for(j in 1:P){
  prob_true[,j] = intercept[j] + slope[j] * 1:J
}

ID = rep(1:P, each=J)

y= matrix(NA, nrow=J, ncol=P)
for(j in 1:P){
  y[,j] = rbinom(J, 1, prob_true[,j])
}

data.frame(person = ID,
           trial = rep(x = 1:J, times = P),
           y = as.vector(y),
           true_y = as.vector(prob_true)
) |>
  ggplot(aes(x = trial, y = y)) +
    geom_point() +
    geom_line(aes(y = true_y), color = "red") +
    facet_wrap(~person)


#### Sinusoidal sim #####
prob_true = matrix(NA, nrow=J, ncol=P)

for(i in 1:P){
  freq = rnorm(1, 7, 1)
  prob_true[,i] = 0.6+0.3*sin((1:J)/freq)
}

ID = rep(1:P, each=J)

y= matrix(NA, nrow=J, ncol=P)
for(j in 1:P){
  y[,j] = rbinom(J, 1, prob_true[,j])
}

data.frame(person = ID,
           trial = rep(x = 1:J, times = P),
           y = as.vector(y),
           true_y = as.vector(prob_true)
) |>
  ggplot(aes(x = trial, y = y)) +
  geom_point() +
  geom_line(aes(y = true_y), color = "red") +
  facet_wrap(~person)
```

